<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="images/favicon.ico" rel="icon">
    <title>Ügyfélkezelés és Oktatók</title>
    <style>
      /*globális box méret*/
      *,*::before,*::after{ box-sizing:border-box; }
      body { font-family: Arial, sans-serif; margin: 20px; padding: 0; background-color: #f4f4f4; }
      h1,h2 { text-align: center; margin-top: 32px; }
      table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 30px; overflow-x: auto; display: block; }
      th,td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 14px; }
      th { background-color: #ff7700; color: white; }
      #hiredTable th { background-color: rgb(58,171,232); }
      button { margin-right: 5px; background-color: #dc3545; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px; }
      button:hover { background-color: #c82333; }
      .hire-btn { background-color: #28a745; }
      .hire-btn:hover { background-color: #218838; }
      #vissza { text-decoration: none; color: red; text-align: center; display: block; margin: 20px auto; }
      @media (max-width: 765px) {
        table th, table td { font-size: 12px; padding: 6px; }
        h1,h2 { font-size: 20px; }
        button { padding: 6px 10px; font-size: 14px; }
      }
    </style>
  </head>
  <body>
    <h1>Ügyfélkezelő rendszer</h1>
    <div id="summary"></div>

    <!-- Időpontok -->
    <table id="appointmentsTable">
      <thead>
        <tr>
          <th>ID</th><th>Név</th><th>Dátum</th><th>Tel. szám</th><th>Időpont</th><th>Csomag</th><th>Oktató</th><th>Megjegyzés</th><th>Törlés</th>
        </tr>
      </thead>
      <tbody id="appointmentsList"></tbody>
    </table>

    <!-- Felvett oktatók -->
    <h2>Felvett oktatók</h2>
    <table id="hiredTable">
      <thead>
        <tr>
          <th>ID</th><th>Név</th><th>Felvétel dátuma</th><th>Aktív ügyfelek száma</th><th>Műveletek</th>
        </tr>
      </thead>
      <tbody id="hiredList"></tbody>
    </table>

    <!-- Nem felvett oktatók -->
    <h2>Nem felvett oktatók</h2>
    <table id="otherTable">
      <thead>
        <tr>
          <th>ID</th><th>Név</th><th>Állapot</th><th>Jelentkezés dátuma</th><th>Műveletek</th>
        </tr>
      </thead>
      <tbody id="otherList"></tbody>
    </table>

    <!-- Inaktív oktatók -->
    <h2>Inaktív oktatók</h2>
    <table id="inactiveTable">
      <thead>
        <tr>
          <th>ID</th><th>Név</th><th>Státusz</th><th>Jelentkezés dátuma</th><th>Műveletek</th>
        </tr>
      </thead>
      <tbody id="inactiveList"></tbody>
    </table>

    <!-- GYIK kérdések -->
    <h2>Kérdések</h2>
    <table id="kerdestable">
      <thead>
        <tr><th>#</th><th>E-mail</th><th>Kérdés</th></tr>
      </thead>
      <tbody id="kerdesList"></tbody>
    </table>

    <!-- Jelszó módosítása -->
    <div id="password-change">
      <h2>Jelszó módosítása</h2>
      <form id="passwordForm">
        <label for="instrId">Oktató ID:</label>
        <input type="number" id="instrId" required min="1" />
        <label for="newPwd">Új jelszó:</label>
        <input type="password" id="newPwd" required />
        <label for="confirmPwd">Új jelszó megerősítése:</label>
        <input type="password" id="confirmPwd" required />
        <button type="submit">Jelszó frissítése</button>
        <div id="pwdChangeMsg"></div>
      </form>
    </div>

    <a id="vissza" href="index.html">Kijelentkezés</a>

    <script>
      const BASE_URL = "https://loter-production.up.railway.app";

      document.addEventListener("DOMContentLoaded", () => {
        // Időpontok betöltése
        async function loadAppointments() {
          try {
            const res = await fetch(`${BASE_URL}/api/Appointments`);
            if (!res.ok) throw new Error();
            const apps = await res.json();
            apps.sort((a,b)=>new Date(a.startTime)-new Date(b.startTime));
            // összegzés
            const now=new Date();
            const countThis=apps.filter(a=>new Date(a.startTime).getMonth()===now.getMonth()).length;
            const countNext=apps.filter(a=>new Date(a.startTime).getMonth()===(now.getMonth()+1)%12).length;
            document.getElementById("summary").innerText=
              `Ebben a hónapban még ${countThis} ügyfél van vissza.\nKövetkező hónapra ${countNext} ügyfélnek van időpontja.`;
            const tbody=document.getElementById("appointmentsList"); tbody.innerHTML="";
            apps.forEach(a=>{
              const s=new Date(a.startTime),e=new Date(a.endTime);
              tbody.insertAdjacentHTML("beforeend`,
                `<tr><td>${a.id}</td><td>${a.clientName}</td><td>${s.toLocaleDateString()}</td><td>${a.phone}</td><td>${s.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} - ${e.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td><td>${a.package}</td><td>${a.instructor}</td><td>${a.notes}</td><td><button onclick="deleteAppointment(${a.id})">Törlés</button></td></tr>`);
            });
          } catch {}         }
        // Oktatók
        async function loadInstructors() {
          try {
            const res=await fetch(`${BASE_URL}/api/Instructors`);
            if(!res.ok) throw Error();
            const ins=await res.json();
            const [hired,others,inactive]=[
              ins.filter(i=>i.status==='Hired'&&i.isActive),
              ins.filter(i=>i.status!=='Hired'&&i.isActive),
              ins.filter(i=>!i.isActive)
            ];
            const fill=(list,idKey)=>{
              const body=document.getElementById(idKey); body.innerHTML="";
              list.forEach(i=>{
                let ops='';
                if(idKey==='hiredList') ops=`<button onclick="deleteInstructor(${i.id})">Törlés</button>`;
                if(idKey==='otherList') ops=`<button class="hire-btn" onclick="hireInstructor(${i.id})">Felvétel</button><button onclick="deleteInstructor(${i.id})">Törlés</button>`;
                if(idKey==='inactiveList') ops=`<button onclick="reactivateInstructor(${i.id})">Reaktiválás</button><button onclick="fullDeleteInstructor(${i.id})">Törlés</button>`;
                const dateApp=new Date(i.applicationDate).toLocaleDateString();
                const dateHire=i.hireDate?new Date(i.hireDate).toLocaleDateString():'–';
                const count=i.activeAppointmentsCount?`${i.activeAppointmentsCount} ügyfél`:'–';
                body.insertAdjacentHTML('beforeend',
                  `<tr><td>${i.id}</td><td>${i.name}</td><td>${idKey==='hiredList'?dateHire: i.status || dateApp}</td><td>${idKey==='hiredList'?count: dateApp}</td><td>${ops}</td></tr>`);
              });
            };
            fill(hired,'hiredList'); fill(others,'otherList'); fill(inactive,'inactiveList');
          } catch {}        }
        // GYIK kérdések betöltése
        async function loadQuestions() {
          try {
            const res=await fetch(`${BASE_URL}/api/Questions`);
            if(!res.ok) throw Error();
            const qs=await res.json();
            const tbody=document.getElementById('kerdesList'); tbody.innerHTML='';
            qs.forEach((q,i)=>{
              tbody.insertAdjacentHTML('beforeend',
                `<tr><td>${i+1}</td><td>${q.email}</td><td>${q.text}</td></tr>`);
            });
          } catch {}        }
        // Jelszó frissítés handler
        document.getElementById('passwordForm').addEventListener('submit',async e=>{
          e.preventDefault();
          const id=document.getElementById('instrId').value;
          const newPwd=document.getElementById('newPwd').value;
          const confPwd=document.getElementById('confirmPwd').value;
          if(newPwd!==confPwd){ alert('Az új jelszavak nem egyeznek.'); return; }
          try{
            const res=await fetch(`${BASE_URL}/api/Instructors/${id}/password`,{
              method:'PATCH',headers:{'Content-Type':'application/json'},
              body:JSON.stringify({ oldPassword:'', newPassword:newPwd })
            });
            if(res.ok){ alert('Jelszó sikeresen frissítve!'); }
            else{ const txt=await res.text(); alert('Hiba: '+txt); }
          }catch{ alert('Hálózati hiba.'); }
        });
        // Inicializálás és frissítés 10s-ként
        loadAppointments(); loadInstructors(); loadQuestions();
        setInterval(()=>{ loadAppointments(); loadInstructors(); loadQuestions(); },10000);
      });

      // Műveletek funkciók (törlés, felvétel, stb.)
      async function deleteAppointment(id){ if(!confirm('Biztos?')) return; await fetch(`${BASE_URL}/api/Appointments/${id}`,{method:'DELETE'}); loadAppointments(); loadInstructors(); }
      async function deleteInstructor(id){ if(!confirm('Biztos?')) return; await fetch(`${BASE_URL}/api/Instructors/${id}`,{method:'DELETE'}); loadInstructors(); loadAppointments(); }
      async function hireInstructor(id){ if(!confirm('Felvétel?')) return; await fetch(`${BASE_URL}/api/Instructors/${id}/hire`,{method:'PATCH'}); loadInstructors(); loadAppointments(); }
      async function reactivateInstructor(id){ if(!confirm('Reaktiválás?')) return; await fetch(`${BASE_URL}/api/Instructors/${id}/reactivate`,{method:'PATCH'}); loadInstructors(); loadAppointments(); }
      async function fullDeleteInstructor(id){ if(!confirm('Végleges törlés?')) return; await fetch(`${BASE_URL}/api/Instructors/${id}/permanent`,{method:'DELETE'}); loadInstructors(); }
    </script>
  </body>
</html>
